suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Type / usage
data %>%
dplyr::filter(!is.na(Type)) %>%
dplyr::mutate(Group = paste("Type:", Type)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Mode Majeur/Mineur
data %>%
dplyr::filter(!is.na(Mode)) %>%
## Le groupe "Majeur" est encombrant
dplyr::filter(!Mode %in% "Majeur") %>%
dplyr::mutate(Group = paste("Mode:", Mode)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Instrument = La Voix ou La Guitare
data %>%
dplyr::filter(!is.na(Instrument)) %>%
## Le groupe "Majeur" est encombrant
dplyr::filter(Instrument %in% c("Vocals", "Muted Trumpet")) %>%
dplyr::mutate(Group = paste("Instrument:", Instrument)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Genre
data %>%
dplyr::rename(Genres = genres) %>%
# dplyr::select(Genres) %>%
## Les triades etiquetees "Son Pop Loce 80's" sont forcement "Pop"
# dplyr::mutate(`Parent Genres` = dplyr::if_else(is.na(`Parent Genres`) & is.na(`Genres`) & Type == "son pop love 80s",
#                                                "Pop",
#                                                `Parent Genres`)) %>%
## On rassemble Genre et Genre Parents
# dplyr::mutate(Genres = paste(Genres, `Parent Genres`, sep = ", ")) %>%
dplyr::filter(purrr::map_lgl(.x = Genres, .f =~ length(.x) > 0L)) %>%
dplyr::distinct(Artist, Genres) %>%
tidyr::unnest(cols = Genres) %>%
dplyr::rename(Genre = Genres) %>%
## On supprime les genres NA
# dplyr::filter(!(is.na(Genre) | Genre == "NA")) %>%
## On supprime les Genres qui ne rassemble pas de chansons
dplyr::group_by(Genre) %>%
dplyr::mutate(Nb_Chansons = dplyr::n()) %>%
dplyr::filter(dplyr::n() > 1L) %>%
## Garder le genre le plus evocateur pour une chansons (des genres sont redondants entre eux)
dplyr::group_by(Artist) %>%
dplyr::arrange(dplyr::desc(Nb_Chansons)) %>%
dplyr::slice(1) %>%
dplyr::mutate(Group = paste("Genre:", Genre)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to)
) %>%
dplyr::relocate(Group, from, to)
edges <- edges %>%
dplyr::mutate(id = 1:dplyr::n())
edges2 <- edges
edges2$from <- edges$to
edges2$to <- edges$from
tmp <- dplyr::bind_rows(edges, edges2) %>%
dplyr::group_by(Group, from, to) %>%
dplyr::arrange(Group, from, to, id) %>%
dplyr::slice(1)
tmp$id %>% unique() %>% length()
edges <- edges %>%
dplyr::filter(id %in% tmp$id) %>%
dplyr::select(-id)
bands <- list(
# Les sommets = les chansons
"vertices" = tibble::tibble(Artist = c(edges$from, edges$to)) %>%
dplyr::distinct(Artist) %>%
## Label et Size
dplyr::left_join(dplyr::distinct(byArtists, Artist, Nb_Triads), # Nb_Songs
by = dplyr::join_by(Artist)) %>%
dplyr::rename(size = Nb_Triads) %>% # Nb_Songs
dplyr::mutate(rownames = Artist) %>%
dplyr::rename(label = Artist) %>%
tibble::column_to_rownames(var = "rownames"),
# Liens
"edges" = edges
)
#### Main Grouping variables ####
# mainGroups <- names(head(sort(table(bands$edges$Group), decreasing = TRUE), n = 6))
## Degrees
mainGroups <- unique(grep(pattern = "^Degr", x = bands$edges$Group, value = TRUE))
suffixGroup <- "Degre-note-mediane"
#### Network plot ####
fb.igra <- igraph::graph_from_data_frame(
d = bands$edges[, c("from", "to")],
directed = FALSE
)
igraph::V(fb.igra)$conf <- bands$vertices[igraph::V(fb.igra)$name, "label"]
igraph::V(fb.igra)$size <- bands$vertices[igraph::V(fb.igra)$name, "size"]
igraph::E(fb.igra)$Group <- bands$edges$Group
#Tips: ctrl+shift+A to reformat
set.seed(3212019)
pggnetwork <- ggplot2::ggplot(
ggnetwork::ggnetwork(# provide the underlying dataframe
fb.igra, #input: network object
layout = igraph::nicely()
),
#can pass layout parameter
ggplot2::aes(x, y, xend = xend, yend = yend)
) + #mapping for edges
ggnetwork::geom_edges(ggplot2::aes(#linetype = as.factor(Admin),
color = gsub(pattern = "Degr\u00e9 de la note m\u00e9diane: ", replacement = "", Group)),
#arrow = arrow(length = unit(6, "pt"), type = "closed") #if directed
# color = "grey50",
data = function(x) { x[ x$Group %in% mainGroups, ]},
curvature = 0.2,
alpha = 0.5
) +
ggnetwork::geom_nodes(ggplot2::aes(size = size),
# size = 3, color = conf
alpha=0.5) +
ggnetwork::geom_nodes(fill = "#E74C3C", #"#D64545", "#C23B22", "red",
color = "black",
size = 5, shape = 21,
data = function(x) { x[ x$conf == "A Thousand Miles", ]}) +
ggplot2::guides(alpha = "none") +
ggnetwork::geom_nodetext(ggplot2::aes(label = insert_line_breaks_adaptive(conf)), # 1st occurence only
size = 2.5, nudge_y = .02)+
# scale_color_brewer("Conference",
#                    palette = "Paired") +
ggplot2::scale_linetype_manual(values = c(2, 1)) +
ggplot2::guides(linetype = "none",
#colour = "none",
size = "none") +
ggplot2::labs(colour = "Degr\u00e9 de la\nnote m\u00e9diane:") +
# ggplot2::scale_colour_discrete() +
ggplot2::scale_colour_manual(
values = c("#EB5646",  # Rouge vif
"#A3472A",  # Terre cuite foncee, plus rustique
"#A3478A",  # Terre cuite foncee, plus rustique
"#FCF1DD",  # Beige clair
"#FCF3EE",
"black",
"#D9A066",  # Ocre dore, pour rechauffer et varier
"#7B2E2E")  # Bordeaux profond, pour l’ancrage visuel
) +
# ggplot2::scale_colour_brewer(palette = 2) +
# ggplot2::scale_color_viridis_d() +
ggnetwork::theme_blank() +
ggplot2::theme(
panel.background = ggplot2::element_rect(fill='transparent'), #transparent panel bg
plot.background = ggplot2::element_rect(fill='transparent', color=NA), #transparent plot bg
panel.grid.major = ggplot2::element_blank(), #remove major gridlines
panel.grid.minor = ggplot2::element_blank(), #remove minor gridlines
legend.background = ggplot2::element_rect(fill='transparent'), #transparent legend bg
legend.box.background = ggplot2::element_rect(fill='transparent') #transparent legend panel
)
pggnetwork
fusen::inflate(flat_file = "dev/flat_scale_palette_triad.Rmd", vignette_name = "Custom Colour Palette",     check = F)
dat %>%
ggplot2::ggplot() +
ggplot2::aes(x = First_Interval, y = Second_Interval, fill = Nb_Songs) +
ggplot2::geom_raster() +
ggplot2::geom_text(ggplot2::aes(label = sub("Triade ", "Triade\n", name)),
colour = dplyr::if_else(dat$Nb_Songs < 160L, "black", "white")) +
ggplot2::scale_x_discrete(limits = as.character(1:2)) +
ggplot2::scale_y_continuous(breaks = 5:10) +
ggplot2::labs(x = "First Interval",
y = "Second Interval",
fill = "Number of\nSongs") +
ggplot2::theme_bw() +
scale_fill_tvc_c()
# ggplot2::scale_fill_viridis_c()
ggplot2::ggsave(glue::glue("../{format(Sys.Date(), format = '%Y%m%d')}-raster-occurence-triads.png"),
width = 7, height = 5)
library(tvc)
triads <- read_sheet_triad()
devtools::load_all()
keysAPI <- get_config(env = "spotify")
file.remove(".httr-oauth") # Mess with spotify authentication
## Exemple Reading private playlist
# songsNegTVC <- tvc:::get_spotify_api_playlist(playlist_id = "1wAEEcvkLBETRvIs06BK1E", scope = "private")
tabTriads <- get_config(env = "spotify")$playlists %>%
purrr::transpose() %>%
tibble::as_tibble() %>%
tidyr::unnest(cols = c(triad, name, playlist))
songs <- tabTriads %>%
# Filter out non-triad
dplyr::filter(grepl(pattern = "^-?[0-9]+ -?[0-9]+$", x = triad)) %>%
dplyr::mutate(songs = purrr::map(
.x = playlist,
.f = ~ tvc:::get_spotify_api_playlist(playlist_id = .x, scope = "private")
))
songs <- songs %>%
tidyr::unnest(cols = songs)
readRDS("songs.RDS")
saveRDS(songs, file = "./songs.RDS")
## Song having the most different triads
songs %>%
## Group Artists
dplyr::group_by(Song, ISRC, triad) %>%
dplyr::summarise(Artist = paste(Artist, collapse = ", ")) %>%
## Count Nb traids
dplyr::group_by(Song, Artist, ISRC) %>%
dplyr::summarise(Nb_triad = length(unique(triad))) %>%
dplyr::ungroup() %>%
dplyr::select(-ISRC) %>%
dplyr::arrange(dplyr::desc(Nb_triad)) %>%
dplyr::slice_head(n = 10L)
write_missing_triade(songs = songs, triads = triads, triadeType = NULL)
triads <- read_sheet_triad()
## Formatting triad and song info
triads <- tvc:::parse_triade(triads, songs)
songs %>%
dplyr::filter(triad == "1 7") %>%
plot_tvc_histogram()
dat <- triads %>%
# Filter out non-triad
dplyr::filter(grepl(pattern = "^-?[0-9]+ -?[0-9]+$", x = `Ordre des Notes`)) %>%
## Extract Intervals
dplyr::mutate(triad_tmp = `Ordre des Notes`) %>%
tidyr::extract(col = triad_tmp, into = c("First_Interval", "Second_Interval"), regex = "^(.*) (.*)$") %>%
dplyr::mutate(dplyr::across(.cols = c(First_Interval, Second_Interval), .fns = as.integer)) %>%
## Count Number of Song per Triad
dplyr::group_by(`Ordre des Notes`, First_Interval, Second_Interval) %>%
dplyr::summarise(Nb_Songs = length(unique(ISRC)), .groups = "drop") %>%
## Filter Out Negative Triad etc.
dplyr::filter(dplyr::between(First_Interval, 0L, 2L),
dplyr::between(Second_Interval, 3L, 11L)) %>%
## Join with triad names
dplyr::left_join(dplyr::select(tabTriads, triad, name), by = dplyr::join_by(`Ordre des Notes` == triad))
dat %>%
ggplot2::ggplot() +
ggplot2::aes(x = First_Interval, y = Second_Interval, fill = Nb_Songs) +
ggplot2::geom_raster() +
ggplot2::geom_text(ggplot2::aes(label = sub("Triade ", "Triade\n", name)),
colour = dplyr::if_else(dat$Nb_Songs < 160L, "black", "white")) +
ggplot2::scale_x_discrete(limits = as.character(1:2)) +
ggplot2::scale_y_continuous(breaks = 5:10) +
ggplot2::labs(x = "First Interval",
y = "Second Interval",
fill = "Number of\nSongs") +
ggplot2::theme_bw() +
scale_fill_tvc_c()
# ggplot2::scale_fill_viridis_c()
ggplot2::ggsave(glue::glue("../{format(Sys.Date(), format = '%Y%m%d')}-raster-occurence-triads.png"),
width = 7, height = 5)
songs %>%
## Remove classical music
dplyr::group_by(ISRC) %>%
dplyr::filter(!any(purrr::map_lgl(.x = genres, .f = ~ "classical" %in% .x))) %>%
dplyr::ungroup() %>%
## Keep one element per SOng, ISRC
dplyr::distinct(Song, ISRC, triad, Album_Year, .keep_all = TRUE) %>%
ggplot2::ggplot() +
ggplot2::aes(Album_Year) +
ggplot2::geom_histogram(binwidth = 1) +
ggplot2::facet_wrap(~ triad) +
ggplot2::theme_bw() +
ggplot2::labs(x = "Album Year",
y = "Number of Songs",
title = "Occurences of triads through History")
ggplot2::ggsave(glue::glue("../{format(Sys.Date(), format = '%Y%m%d')}-histogram-all-triads.png"),
width = 11, height = 7)
## Songs contemporaines de A Thousand Miles
songs %>%
dplyr::filter(dplyr::between(Album_Date, "2002-04-29", "2004-04-30"))
## Songs contemporaines de A Thousand Miles
songs %>%
dplyr::filter(dplyr::between(Album_Date, "2002-04-29", "2003-04-30"))
## Songs contemporaines de A Thousand Miles
songs %>%
dplyr::filter(dplyr::between(Album_Date, "2002-04-29", "2003-04-30")) %>%
dplyr::filter(triad == "1 7") %>%
dplyr::select(Song, Artist)
## Songs contemporaines de A Thousand Miles
songs %>%
dplyr::filter(dplyr::between(Album_Date, "2002-04-29", "2003-04-30")) %>%
dplyr::filter(triad == "1 7") %>%
dplyr::select(Song, Artist, Album_Date)
## Network plot
plot_tvc_network(triads)
data = triads
data <- data %>%
dplyr::filter(!is.na(Degree),
`Ordre des Notes` == "1 7") %>%
## On garde seulement les artistes qui utilisent massivement
dplyr::group_by(Artist) %>%
dplyr::filter(length(unique(ISRC)) > 1L) %>%
dplyr::ungroup()
#### Calcul des liens ####
byArtists <- data %>%
dplyr::group_by(Artist) %>%
dplyr::mutate(Nb_Songs = length(unique(ISRC)),
Nb_Triads = dplyr::n())
edges <- dplyr::bind_rows(
## Harmonie Sous-Jacente
data %>%
dplyr::filter(!is.na(`Harmonie Sous-Jacente`)) %>%
dplyr::mutate(Group = paste("Harmonie sous-Jacente:", `Harmonie Sous-Jacente`)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Degre de la note mediane
data %>%
dplyr::filter(!is.na(Degree)) %>%
dplyr::mutate(Group = paste("Degr\u00e9 de la note m\u00e9diane:", Degree)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Type / usage
data %>%
dplyr::filter(!is.na(Type)) %>%
dplyr::mutate(Group = paste("Type:", Type)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Mode Majeur/Mineur
data %>%
dplyr::filter(!is.na(Mode)) %>%
## Le groupe "Majeur" est encombrant
dplyr::filter(!Mode %in% "Majeur") %>%
dplyr::mutate(Group = paste("Mode:", Mode)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Instrument = La Voix ou La Guitare
data %>%
dplyr::filter(!is.na(Instrument)) %>%
## Le groupe "Majeur" est encombrant
dplyr::filter(Instrument %in% c("Vocals", "Muted Trumpet")) %>%
dplyr::mutate(Group = paste("Instrument:", Instrument)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to),
## Genre
data %>%
dplyr::rename(Genres = genres) %>%
# dplyr::select(Genres) %>%
## Les triades etiquetees "Son Pop Loce 80's" sont forcement "Pop"
# dplyr::mutate(`Parent Genres` = dplyr::if_else(is.na(`Parent Genres`) & is.na(`Genres`) & Type == "son pop love 80s",
#                                                "Pop",
#                                                `Parent Genres`)) %>%
## On rassemble Genre et Genre Parents
# dplyr::mutate(Genres = paste(Genres, `Parent Genres`, sep = ", ")) %>%
dplyr::filter(purrr::map_lgl(.x = Genres, .f =~ length(.x) > 0L)) %>%
dplyr::distinct(Artist, Genres) %>%
tidyr::unnest(cols = Genres) %>%
dplyr::rename(Genre = Genres) %>%
## On supprime les genres NA
# dplyr::filter(!(is.na(Genre) | Genre == "NA")) %>%
## On supprime les Genres qui ne rassemble pas de chansons
dplyr::group_by(Genre) %>%
dplyr::mutate(Nb_Chansons = dplyr::n()) %>%
dplyr::filter(dplyr::n() > 1L) %>%
## Garder le genre le plus evocateur pour une chansons (des genres sont redondants entre eux)
dplyr::group_by(Artist) %>%
dplyr::arrange(dplyr::desc(Nb_Chansons)) %>%
dplyr::slice(1) %>%
dplyr::mutate(Group = paste("Genre:", Genre)) %>%
dplyr::distinct(Artist, Group) %>%
dplyr::full_join(x = ., y = .,
by = dplyr::join_by(Group),
relationship = "many-to-many",
suffix = c("_from", "_to")) %>%
dplyr::rename(from = Artist_from,
to = Artist_to) %>%
dplyr::filter(from != to)
) %>%
dplyr::relocate(Group, from, to)
edges <- edges %>%
dplyr::mutate(id = 1:dplyr::n())
edges2 <- edges
edges2$from <- edges$to
edges2$to <- edges$from
tmp <- dplyr::bind_rows(edges, edges2) %>%
dplyr::group_by(Group, from, to) %>%
dplyr::arrange(Group, from, to, id) %>%
dplyr::slice(1)
tmp$id %>% unique() %>% length()
edges <- edges %>%
dplyr::filter(id %in% tmp$id) %>%
dplyr::select(-id)
bands <- list(
# Les sommets = les chansons
"vertices" = tibble::tibble(Artist = c(edges$from, edges$to)) %>%
dplyr::distinct(Artist) %>%
## Label et Size
dplyr::left_join(dplyr::distinct(byArtists, Artist, Nb_Triads), # Nb_Songs
by = dplyr::join_by(Artist)) %>%
dplyr::rename(size = Nb_Triads) %>% # Nb_Songs
dplyr::mutate(rownames = Artist) %>%
dplyr::rename(label = Artist) %>%
tibble::column_to_rownames(var = "rownames"),
# Liens
"edges" = edges
)
#### Main Grouping variables ####
# mainGroups <- names(head(sort(table(bands$edges$Group), decreasing = TRUE), n = 6))
## Degrees
mainGroups <- unique(grep(pattern = "^Degr", x = bands$edges$Group, value = TRUE))
suffixGroup <- "Degre-note-mediane"
#### Network plot ####
fb.igra <- igraph::graph_from_data_frame(
d = bands$edges[, c("from", "to")],
directed = FALSE
)
igraph::V(fb.igra)$conf <- bands$vertices[igraph::V(fb.igra)$name, "label"]
igraph::V(fb.igra)$size <- bands$vertices[igraph::V(fb.igra)$name, "size"]
igraph::E(fb.igra)$Group <- bands$edges$Group
#Tips: ctrl+shift+A to reformat
set.seed(3212019)
pggnetwork <- ggplot2::ggplot(
ggnetwork::ggnetwork(# provide the underlying dataframe
fb.igra, #input: network object
layout = igraph::nicely()
),
#can pass layout parameter
ggplot2::aes(x, y, xend = xend, yend = yend)
) + #mapping for edges
ggnetwork::geom_edges(ggplot2::aes(#linetype = as.factor(Admin),
color = gsub(pattern = "Degr\u00e9 de la note m\u00e9diane: ", replacement = "", Group)),
#arrow = arrow(length = unit(6, "pt"), type = "closed") #if directed
# color = "grey50",
data = function(x) { x[ x$Group %in% mainGroups, ]},
curvature = 0.2,
alpha = 0.5
) +
ggnetwork::geom_nodes(ggplot2::aes(size = size),
# size = 3, color = conf
alpha=0.5) +
ggnetwork::geom_nodes(fill = "#E74C3C", #"#D64545", "#C23B22", "red",
color = "black",
size = 5, shape = 21,
data = function(x) { x[ x$conf == "A Thousand Miles", ]}) +
ggplot2::guides(alpha = "none") +
ggnetwork::geom_nodetext(ggplot2::aes(label = insert_line_breaks_adaptive(conf)), # 1st occurence only
size = 2.5, nudge_y = .02)+
# scale_color_brewer("Conference",
#                    palette = "Paired") +
ggplot2::scale_linetype_manual(values = c(2, 1)) +
ggplot2::guides(linetype = "none",
#colour = "none",
size = "none") +
ggplot2::labs(colour = "Degr\u00e9 de la\nnote m\u00e9diane:") +
# ggplot2::scale_colour_discrete() +
ggplot2::scale_colour_manual(
values = c("#EB5646",  # Rouge vif
"#A3472A",  # Terre cuite foncee, plus rustique
"#A3478A",  # Terre cuite foncee, plus rustique
"#FCF1DD",  # Beige clair
"#FCF3EE",
"black",
"#D9A066",  # Ocre dore, pour rechauffer et varier
"#7B2E2E")  # Bordeaux profond, pour l’ancrage visuel
) +
# ggplot2::scale_colour_brewer(palette = 2) +
# ggplot2::scale_color_viridis_d() +
ggnetwork::theme_blank() +
ggplot2::theme(
panel.background = ggplot2::element_rect(fill='transparent'), #transparent panel bg
plot.background = ggplot2::element_rect(fill='transparent', color=NA), #transparent plot bg
panel.grid.major = ggplot2::element_blank(), #remove major gridlines
panel.grid.minor = ggplot2::element_blank(), #remove minor gridlines
legend.background = ggplot2::element_rect(fill='transparent'), #transparent legend bg
legend.box.background = ggplot2::element_rect(fill='transparent') #transparent legend panel
)
pggnetwork
